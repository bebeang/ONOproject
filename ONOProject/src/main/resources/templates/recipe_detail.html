<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container my-3">

   <!-- 레시피 제목-->
   <h2 class="border-bottom py-2" th:text="${recipe.subject}"></h2>

   <!-- 레시피 -->
   <div class="card my-3">
      <div class="card-head" align="center" style="margin-top: 50px">

         <table class="table table-borderless" style="width: 1000px;">

            <!-- 요리 썸네일 -->
            <tr>
               <td rowspan="5" style="width: 600px"><img
                  th:src="${recipe.filePath}" class="img-thumbnail"
                  style="width: 600px; height: 400px;"> <!-- 레시피 추천 버튼 -->
                  <div align="center" style="margin-top: 10px">
                     <a class="recommend btn btn-sm btn-outline-danger"
                        th:data-uri="@{|/recipe/vote/${recipe.id}|}">추천 <span
                        class="badge rounded-pill bg-danger"
                        th:text="${#lists.size(recipe.voter)}"></span>
                     </a>

                     <!-- 질문 수정 버튼 -->
                     <a th:href="@{|/recipe/modify/${recipe.id}|}"
                        class="btn btn-sm btn-outline-warning"
                        sec:authorize="isAuthenticated()"
                        th:if="${recipe.author != null and 
                         ((#authentication instanceof T(org.springframework.security.authentication.UsernamePasswordAuthenticationToken) and 
                         #authentication.principal.username == recipe.author.username) or
                         (#authentication instanceof T(org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken) and
                         #authentication.principal.attributes['email'] == recipe.author.email))}"
                        th:text="수정"></a>

                     <!-- 질문 삭제 버튼 -->
                     <a th:data-uri="@{|/recipe/delete/${recipe.id}|}"
                        class="delete btn btn-sm btn-outline-warning"
                        sec:authorize="isAuthenticated()"
                        th:if="${recipe.author != null and 
                         ((#authentication instanceof T(org.springframework.security.authentication.UsernamePasswordAuthenticationToken) and 
                         #authentication.principal.username == recipe.author.username) or
                         (#authentication instanceof T(org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken) and
                         #authentication.principal.attributes['email'] == recipe.author.email))}"
                        th:text="삭제"></a>
                  </div></td>

               <!-- 요리 작성자 -->
               <td><div class="border-bottom py-2 float-end">
                     <span th:if="${recipe.author != null}"
                        th:text="${recipe.author.nickname}"
                        style="vertical-align: bottom"></span> <img
                        th:src="${profilePath}" class="rounded" width=80px " height=80px">
                  </div></td>
            </tr>

            <!-- 요리제목 -->
            <tr>
               <td><h3>
                     <span style="margin-left: 30px" th:text="${recipe.subject}"></span>
                  </h3></td>
            </tr>

            <!-- 요리소개 -->
            <tr>
               <td><div style="color: gray; margin-left: 30px"
                     th:text="${recipe.cookIntro}"></div></td>
            </tr>

            <!-- 요리 재료 -->
            <tr>
               <td>
                  <h5>
                     <span style="margin-left: 30px;">재료 <small
                        class="text-muted">Ingredients</small></span>
                  </h5>
                  <h6>
                     <th:block
                        th:each="ingredient, index : ${#strings.arraySplit(recipe.ingredient, ',')}">
                        <span th:text="${ingredient}"
                           style="margin-left: 30px; text-align: left; display: inline-block; width: 30%;"></span>
                        <span th:text="' '"></span>
                        <span
                           th:text="${#strings.arraySplit(recipe.capacity, ',')[__${index.index}__]}"
                           style="text-align: right; display: inline-block; width: 30%;"></span>
                        <br />
                  </h6> </th:block>
               </td>
            </tr>
         </table>

         <!-- 최초 작성 일시       
            <div class="badge bg-light text-dark p-2 text-start">
               <div th:text="${#temporals.format(recipe.createDate, 'yyyy-MM-dd HH:mm')}"></div>
            </div> -->

         <!-- 수정 일시 
             <div th:if="${recipe.modifyDate != null}" class="badge bg-light text-dark p-2 text-start mx-3">
                    <div class="mb-2">수정됨</div>
                    <div th:text="${#temporals.format(recipe.modifyDate, 'yyyy-MM-dd HH:mm')}"></div>
             </div> -->


         <!-- 레시피 내용 -->
         <table class="table table-bordered"
            style="width: 1000px; margin-top: 100px;">
            <tr class="text-center">
               <!-- 요리 정보(인원/시간/난이도) -->
               <td><img src="/image/people.jpg"
                  style="width: 40px; height: 40px;">
                  <div th:text="${recipe.cookInfo_people}"></div></td>
               <td><img src="/image/time.jpg"
                  style="width: 40px; height: 40px;">
                  <div th:text="${recipe.cookInfo_time}"></div></td>
               <td><img src="/image/level.jpg"
                  style="width: 40px; height: 40px;">
                  <div th:text="${recipe.cookInfo_level}"></div></td>
            </tr>
         </table>

         <!-- 마크다운 적용 -->
         <!-- 요리 레시피 -->
         <table class="table" style="width: 1000px;">
            <h5 class="text-start"
               style="margin-top: 100px; margin-left: 150px;">
               조리순서 <small class="text-muted">Steps</small>
            </h5>

            <th:block
               th:each="content, index : ${#strings.arraySplit(recipe.content, ',')}">
               <tr>
                  <td rowspan='2'
                     style="width: 400px; height: 400px; border-bottom: none;"><img
                     th:src="${recipe.contentFilePaths[index.index]}"
                     class="img-thumbnail"
                     style="width: 400px; height: 400px; margin-bottom: 100px">
                  </td>
                  <td style="height: 50px"><span
                     th:text="'Step ' + (${index.index + 1})"
                     style="font-size: 20px; font-weight: bold; margin-left: 20px"></span>
                  </td>
               </tr>
               <tr>
                  <td style="border-bottom: none;">
                     <div th:text="${content}" style="margin-left: 20px"></div>
                  </td>
               </tr>
            </th:block>
         </table>

         <div class="d-flex justify-content-end">

            <!-- 수정 일시 -->
            <div th:if="${recipe.modifyDate != null}"
               class="badge bg-light text-dark p-2 text-start mx-3">
               <div class="mb-2">수정됨</div>
               <div
                  th:text="${#temporals.format(recipe.modifyDate, 'yyyy-MM-dd HH:mm')}"></div>
            </div>

            <!-- 최초 작성 일시 -->
            <div class="badge bg-light text-dark p-2 text-start">
               <div
                  th:text="${#temporals.format(recipe.createDate, 'yyyy-MM-dd HH:mm')}"></div>
            </div>
         </div>

         <!-- 마트 카카오 지도 api -->
         <div id="map" sec:authorize="isAuthenticated()"
            style="width: 500px; height: 400px;"></div>

         <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e29d4d2efe0c5f7564016c5180156651&libraries=services"></script>
         <script type="text/javascript"
            src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=e29d4d2efe0c5f7564016c5180156651&autoload=false&libraries=services"></script>
         <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
         <script type="text/javascript">
            kakao.maps.load(function() {
               $.ajax({
                  type : 'get',
                  url : '/recipe/presentAddress',
                  
                  success:function(response){
                     
                     var encodedAddress = response;
                     var presentAddress = decodeURIComponent(encodedAddress);
                     var geocoder = new kakao.maps.services.Geocoder();
                      
                     geocoder.addressSearch(presentAddress, function(result, status){
                        console.log(presentAddress);
                        if(status === kakao.maps.services.Status.OK){
                           console.log(result);
                           var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
                            mapOption = {
                                center: new kakao.maps.LatLng(result[0].y, result[0].x), // 지도의 중심좌표
                                level: 3 // 지도의 확대 레벨
                            };  
                           
                           //지도 생성
                           var map = new kakao.maps.Map(mapContainer, mapOption); 
                           
                           // 마커를 클릭하면 장소명을 표출할 인포윈도우 입니다
                           var infowindow = new kakao.maps.InfoWindow({zIndex:1});
                           //장소 검색 개체 생성
                           var ps = new kakao.maps.services.Places();
                           
                           //키워드 검색 시 범위 지정 위한 latlng 선언
                           var mapLatlng = new kakao.maps.LatLng(result[0].y, result[0].x);
                           //키워드 검색 시 범위 지정
                           keyOptions = {
                                 location : mapLatlng
                           };
                           //키워드로 장소를 검색
                           ps.keywordSearch('마트', placesSearchCB, keyOptions);
                           //키워드 검색 완료 시 호출되는 콜백함수
                           function placesSearchCB(data, status, pagination){
                              if(status === kakao.maps.services.Status.OK){
                                 // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
                                   // LatLngBounds 객체에 좌표를 추가합니다
                                   var bounds = new kakao.maps.LatLngBounds();

                                   for (var i=0; i<5; i++) {
                                       displayMarker(data[i]);    
                                       bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
                                   }       

                                   // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
                                   map.setBounds(bounds);
                              }
                           }      
                           // 지도에 마커를 표시하는 함수입니다
                           function displayMarker(place) {
                               
                               // 마커를 생성하고 지도에 표시합니다
                               var marker = new kakao.maps.Marker({
                                   map: map,
                                   position: new kakao.maps.LatLng(place.y, place.x) 
                               });

                               // 마커에 클릭이벤트를 등록합니다
                               kakao.maps.event.addListener(marker, 'click', function() {
                                   // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
                                   infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
                                   infowindow.open(map, marker);
                               });
                           }
                           
                        }
                     }); 
                  }
               
               });//end ajax
               
                // v3가 모두 로드된 후, 이 콜백 함수가 실행됩니다.
                //var map = new kakao.maps.Map(mapContainer, mapOption);
            });
            </script>

         <!-- 답변 -->
         <!-- 답변의 갯수 표시 -->
         <h5 class="border-bottom my-3 py-2"
            th:text="|${#lists.size(recipe.answerList)}개의 답변이 있습니다.|"></h5>

         <!-- 답변 반복 시작 -->
         <div class="card my-3" th:each="answer : ${recipe.answerList}">

            <!-- 답변 앵커 추가 -->
            <a th:id="|answer_${answer.id}|"></a>

            <div class="card-body">
               <!-- 마크다운 적용 -->
               <div class="card-text"
                  th:utext="${@commonUtil.markdown(answer.content)}"></div>
               <div class="d-flex justify-content-end">

                  <!-- 답변 수정일시 -->
                  <div th:if="${answer.modifyDate != null}"
                     class="badge bg-light text-dark p-2 text-start mx-3">
                     <div class="mb-2">수정됨</div>
                     <div
                        th:text="${#temporals.format(answer.modifyDate, 'yyyy-MM-dd HH:mm')}"></div>
                  </div>

                  <div class="badge bg-light text-dark p-2 text-start">
                     <div class="mb-2">
                        작성자 : <span th:if="${answer.author != null}"
                           th:text="${answer.author.username}"></span>
                     </div>
                     <div
                        th:text="${#temporals.format(answer.createDate, 'yyyy-MM-dd HH:mm')}"></div>
                  </div>
               </div>

               <!-- 버튼 -->
               <div class="my-3">

                  <!-- 답변 추천 버튼 -->
                  <a class="recommend btn btn-sm btn-outline-secondary"
                     th:data-uri="@{|/answer/vote/${answer.id}|}">추천 <span
                     class="badge rounded-pill bg-success"
                     th:text="${#lists.size(answer.voter)}"></span>
                  </a>

                  <!-- 답변 수정 버튼 -->
                  <a th:href="@{|/answer/modify/${answer.id}|}"
                     class="btn btn-sm btn-outline-warning"
                     sec:authorize="isAuthenticated()"
                     th:if="${answer.author != null and 
                  ((#authentication instanceof T(org.springframework.security.authentication.UsernamePasswordAuthenticationToken) and 
                      #authentication.principal.username == answer.author.username) or
                       (#authentication instanceof T(org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken) and
                       #authentication.principal.attributes['email'] == answer.author.email))}"
                     th:text="수정"></a>

                  <!-- 답변 삭제 버튼 -->
                  <a th:data-uri="@{|/answer/delete/${answer.id}|}"
                     class="delete btn btn-sm btn-outline-warning"
                     sec:authorize="isAuthenticated()"
                     th:if="${answer.author != null and 
                  ((#authentication instanceof T(org.springframework.security.authentication.UsernamePasswordAuthenticationToken) and 
                      #authentication.principal.username == answer.author.username) or
                       (#authentication instanceof T(org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken) and
                       #authentication.principal.attributes['email'] == answer.author.email))}"
                     th:text="삭제"></a>
               </div>
            </div>
         </div>
         <!-- 답변 반복 끝  -->

         <!-- 답변 작성 -->
         <form th:action="@{|/answer/create/${recipe.id}|}"
            th:object="${answerFormDto}" method="post" class="my-3">
            <div th:replace="form_errors :: formErrorsFragment"></div>
            <textarea sec:authorize="isAnonymous()" disabled
               th:field="*{content}" class="form-control" rows="10"></textarea>
            <textarea sec:authorize="isAuthenticated()" th:field="*{content}"
               class="form-control" rows="10"></textarea>
            <input type="submit" value="답변등록" class="btn btn-warning my-2">
         </form>

      </div>
</html>